<?phpnamespace frontend\controllers;use common\helpers\Convert;use common\models\Anchor;use common\models\Article;use common\models\Blog;use common\models\CategoryImages;use common\models\Config;use common\models\Images;use common\models\NavList;use yii\web\Controller;use common\models\Category;use yii\helpers\ArrayHelper;use yii;use yii\helpers\Html;class CommonController extends Controller{    public $data ;    public $lanmu;    public $controllerName;    public $nav_tree=array('case','military','robotic','medical','instrument','survey','handheld','page/lithium-battery-research-institute.html','page/test-center.html','page/scientific-laboratory.html','page/product-certification.html','page/company-profile.html','page/qualifications-honors.html','page/history.html','page/research-and-development-team.html','page/research-platform-and-patent.html');//判断是否现实树形的分类    public function common(){//        header("Vary: User-Agent, Accept");        //钜大至今的年份        $year=date('Y',time())-'2002';        Yii::$app->params['year']=$year;         Yii::$app->params['nav_tree']=$this->nav_tree;//        获取导航栏数组        $tree_list=array();        $first_nav=Category::find()->where(['pid'=>0,'status'=>1])->orWhere(['top'=>1,'status'=>1])->orderBy(['sort'=>SORT_ASC])->all();//        获取部分公共的分类列表        Yii::$app->params['anchor']=NavList::find()->orderBy(['sort'=>SORT_ASC])->all();        $tree_list=$first_nav;        Yii::$app->params['tree_list']=$tree_list;        Yii::$app->params['randProduct']=Images::find()->orderBy('rand()')->limit(4)->all();//随机产品        Yii::$app->params['nav_tree_block']=false;        $action= Yii::$app->controller->action->id;//获取方法名        $controllerName=Yii::$app->controller->id;//获取类名        $this->controllerName=$controllerName;        $this->controllerName=$controllerName;        Yii::$app->params['controllerName']=$controllerName;        Yii::$app->params['breadcrumbs'][]=Html::tag('a',"Home",['href'=>Yii::$app->homeUrl]);//面包屑        if ($controllerName=='page'){            $this->lanmu=Category::find()->where(['like','name',$action])->one();            $self_lanmu=Category::find()->where(['id'=>$this->lanmu['pid']])->one();        }else{            $self_lanmu=Category::find()->where(['name'=>$controllerName])->one();        }        if ($self_lanmu['pid']!=0){//如果不是真正的父栏目，因为为了优化URL，二级栏目当一级栏目的方式写            $top_lanm=Category::find()->where(['id'=>$self_lanmu['pid']])->asArray()->one();//            三级目录            if ($top_lanm['pid']!=0){                $top_top_lanm=Category::find()->where(['id'=>$top_lanm['pid']])->asArray()->one();                Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$top_top_lanm['title'],['href'=>'/'.$top_top_lanm['name'].'/']);            }            if (empty($top_lanm['url'])){                Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$top_lanm['title'],['href'=>'/'.$top_lanm['name'].'/']);            }else{                Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$top_lanm['title'],['href'=>$top_lanm['url']]);            }        }            Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$self_lanmu['title'],['href'=>'/'.$controllerName.'/']);        if ($action!='index'){            if ($action!='detail'){                $this->lanmu=Category::find()->where(['like','name',$action])->one();                Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$this->lanmu['title'],['href'=>'/'.$controllerName.'/'.$action.'/']);            }else{                $id=Yii::$app->request->get('id');                $article=Article::find()->select(['category_id'])->where(['id'=>$id])->andWhere(['status'=>1])->one();                $this->lanmu=Category::find()->where(['id'=>$article['category_id']])->one();                // Yii::$app->params['breadcrumbs'][]='>'.Html::tag('a',$this->lanmu['title'],['href'=>'/'.$controllerName.'/'. $this->lanmu['name'].'/ ']);            }//            echo '----4--';        }else{                       $this->lanmu=$self_lanmu;        }        $this->data['lanmu']=$this->lanmu;         Yii::$app->params['lanmu']=$this->lanmu;//         获取同栏目或许该栏目下的栏目        if ($this->lanmu['pid']==0){            Yii::$app->params['list_lanmu']=Category::find()->where(['pid'=>$this->lanmu['id']])->andWhere(['status'=>1])->orderBy('sort ASC')->all();        }else{            Yii::$app->params['list_lanmu']=Category::find()->where(['pid'=>$this->lanmu['pid']])->andWhere(['status'=>1])->orderBy('sort ASC')->all();        }//        var_dump(Yii::$app->params['list_lanmu']);//        var_dump(Yii::$app->params['breadcrumbs']);        if (ArrayHelper::isIn($action,$this->nav_tree)||ArrayHelper::isIn($controllerName,$this->nav_tree)){            Yii::$app->params['nav_tree_block']=true;//判断是否现实树形的分类        }         $title='';        $keywords='';        $description='';        if ($controllerName=='index'){            $title='Custom Lithium ion Battery Pack, 18650 Battery China Manufacturer - 17 Years | Large Power';            $keywords='Large Power, Custom Lithium ion Battery Pack, China 18650 Battery Manufacturer   ';            $description='Large Power manufacture & supply Lithium ion Battery, 18650 battery pack, lithium power battery, energy storage battery, LiFePO4 battery for all industrial applications, high safety and reliability.';        }elseif ($action=='detail'){            $id=Yii::$app->request->get('id');            $jiami=new Convert(32);            $id=$jiami->stringToId($id);            if (in_array($controllerName,['product','chuneng','diwen','special','taisuanli','lidianchi12v','lidianchi24v','lidianchi36v','lidianchi48v','lidianchi3v7','lidianchi7v4','lidianchi11v1','lidianchi14v8','otherenergy','gongye','lilizi','juhewu','lifepo4','otherlion','juhewu3v7','juhewu7v4','juhewu11v1','otherjuhewu','portablepower'])){                $item=Images::find()                    ->where(['id'=>$id])                    ->one();                if (isset($item)){                    $title=$item->title.'-'.$item->cat->name.' | Large Power';                    $keywords=$item->title.','.$item->cat->name.',Large Power';                    $description=$item->title .'Nominal voltage:'.$item->dianya.'V;Nominal capacity:'.$item->rongliang.'mAh;Model number:'.$item->xinghao .';Dimension:'.$item->chicun .';Application:'.$item->lingyu;                }            }elseif (in_array($controllerName,['news','gongsixinwen','dianchizhunati','hangye','zhishi','solution','robot','yiliao','yiqiyibiao','jinrong','chunenanli','yanjiuyan','case'])){                $item=Article::find()                    ->where(['id'=>$id])                    ->andWhere(['status'=>1])                    ->one();                if (isset($item)){                    $title=$item->title.'-'.$item->category->name.' | Large Power';                    $keywords=$item->title.','.$item->category->name.',Large Power';                    $arr=explode(".", strip_tags($item->content) );                    $description='Large Power'.$item->category->name.$arr[0].$arr[1];                }            }        }else{                       if (!isset($this->lanmu)) {                $this->lanmu=Category::find()->where(['like','name',$action])->one();                            }            $title=$this->lanmu['meta_title'].' | Large Power';            $keywords=$this->lanmu['keywords'];            $description=$this->lanmu['description'];        }         $this->view->params['meta_title']=$title;         $this->view->params['keywords']=$keywords;         $this->view->params['description']=$description;//         随机调取相关文章//        $randAtricle=Article::find()->where(['in','category_id',[36,37,38]])->andWhere(['status'=>1])->orderBy()->limit(11)->all();        $randAtricle=Yii::$app->db->createCommand("SELECT id,title,description,create_time FROM yii2_article where category_id in (36,37,38) ORDER BY RAND() LIMIT 11")->queryAll();;        $this->view->params['randAtricle']=$randAtricle;//        var_dump($randAtricle);        Yii::$app->params['LithiumPowerBattery']=Category::find()->where(['pid'=>60])->all();        return true;    }	public function init(){//          初始化后台的数据        foreach (Config::find()->all() as $key=>$value){            Yii::$app->params['web'][$value->name]=$value;        }	}	public function get_lanmu($obj){    }    public function get_controller_name(){        $shibie=str_replace('frontend\controllers\\','',$this::className());        $shibie=strtolower(str_replace('Controller','',$shibie));        return $shibie;    }    public  function  ca_image_list($id,$num,$order='create_time DESC',$where=[]){        $pid=Category::find()->where(['id'=>$id])->select(['pid'])->one();        if($pid->pid==0){            $tezhong_list_id=Category::find()->where(['pid'=>$id])->select('id')->orderBy('sort ASC')->asArray()->all();            $tezhong_list_id_array=ArrayHelper::getColumn($tezhong_list_id,'id');        }else{            $tezhong_list_id_array=$id;        }        $products_id=CategoryImages::find()->where(['category_id'=>$tezhong_list_id_array])->groupBy('images_id')->asArray()->all();        $products_id_array=ArrayHelper::getColumn($products_id,'images_id');        $product_list=Images::find()            ->where(['id'=>$products_id_array])            ->andWhere($where)            ->orderBy($order)            ->limit($num)            ->all()        ;        return $product_list;    }    public  function  ca_lujin_image_list($id,$num,$order='create_time DESC',$np=null){        $pid=Category::find()->where(['id'=>$id])->select(['pid'])->one();        if($pid->pid==0){            $tezhong_list_id=Category::find()->where(['pid'=>$id])->select('id')->orderBy('sort ASC')->asArray()->all();            $tezhong_list_id_array=ArrayHelper::getColumn($tezhong_list_id,'id');        }else{            $tezhong_list_id_array=$id;        }        $qure=Images::find()            ->where(['in','category_id2',$tezhong_list_id_array])            ->orderBy($order)            ->limit($num);        if (isset($np)){            $qure->andWhere(['like','np',$np]);        }        $product_list=$qure->all();        return $product_list;    }}